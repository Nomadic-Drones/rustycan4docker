# Reboot Recovery Flow Diagram

## Call Flow: Container Start After Reboot

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Docker Daemon                              â”‚
â”‚  (Container restart triggered by restart policy)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ POST /NetworkDriver.Join
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    main.rs: api_network_join()                   â”‚
â”‚  â€¢ Parse NetworkID, EndpointID, SandboxKey                      â”‚
â”‚  â€¢ Extract options                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              manager.rs: endpoint_attach()                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ†• REBOOT RESILIENCE PHASE 1                           â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  1. Check if endpoint exists in memory                 â”‚    â”‚
â”‚  â”‚     endpoint_list.contains_key(&epuid)?                â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  2. If missing (post-reboot scenario):                 â”‚    â”‚
â”‚  â”‚     â€¢ Create new Endpoint::new(epuid)                  â”‚    â”‚
â”‚  â”‚     â€¢ Add to network's endpoint_list                   â”‚    â”‚
â”‚  â”‚     â€¢ Log: "Endpoint not found in memory, recreating" â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  3. Extract peer options from JSON                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              network.rs: endpoint_attach()                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ†• REBOOT RESILIENCE PHASE 2                           â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  1. Ensure network interface exists:                   â”‚    â”‚
â”‚  â”‚     ensure_network_interface_exists()                  â”‚    â”‚
â”‚  â”‚     â”œâ”€â†’ Check: network_interface_exists()?            â”‚    â”‚
â”‚  â”‚     â””â”€â†’ If missing: ip link add vcan{id}              â”‚    â”‚
â”‚  â”‚                    ip link set up vcan{id}             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ†• REBOOT RESILIENCE PHASE 3                           â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  2. Ensure endpoint interface exists:                  â”‚    â”‚
â”‚  â”‚     endpoint.ensure_interface_exists()                 â”‚    â”‚
â”‚  â”‚     â”œâ”€â†’ Check: interface_exists()?                    â”‚    â”‚
â”‚  â”‚     â””â”€â†’ If missing: ip link add vxcan{id}             â”‚    â”‚
â”‚  â”‚                    ip link set up vxcan{id}            â”‚    â”‚
â”‚  â”‚     â€¢ Returns: Ok(true) if recreated                   â”‚    â”‚
â”‚  â”‚     â€¢ Log: "Successfully recreated interface pair"     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ STANDARD OPERATION (Enhanced)                          â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  3. Setup cangw rules:                                 â”‚    â”‚
â”‚  â”‚     â€¢ Network â†’ Endpoint (bidirectional)               â”‚    â”‚
â”‚  â”‚     â€¢ For each peer endpoint:                          â”‚    â”‚
â”‚  â”‚       â”œâ”€â†’ ğŸ†• Validate peer interface exists           â”‚    â”‚
â”‚  â”‚       â”œâ”€â†’ If missing: Skip with warning               â”‚    â”‚
â”‚  â”‚       â””â”€â†’ If exists: Create cross-rules               â”‚    â”‚
â”‚  â”‚           Peer â†’ This (bidirectional)                  â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  4. Return JoinResponse with interface names           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ JoinResponse
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Docker Daemon                              â”‚
â”‚  â€¢ Moves peer interface to container namespace                  â”‚
â”‚  â€¢ Container starts successfully                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Transitions

### Endpoint State Machine

```
                    Docker calls CreateEndpoint
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Endpoint        â”‚
                    â”‚  Created         â”‚
                    â”‚  (in memory)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚
            Normal Start          After Reboot
                    â”‚                  â”‚
                    â–¼                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Interface       â”‚   â”‚  Interface       â”‚
         â”‚  Exists          â”‚   â”‚  Missing         â”‚
         â”‚  (in kernel)     â”‚   â”‚  (kernel reset)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                      â”‚
                  â”‚               ğŸ†• Auto-Recovery
                  â”‚                      â”‚
                  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚              â”‚  Recreate       â”‚
                  â”‚              â”‚  Interface      â”‚
                  â”‚              â”‚  Transparently  â”‚
                  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                  Docker calls Join
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Endpoint        â”‚
                    â”‚  Attached        â”‚
                    â”‚  (cangw rules)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Decision Tree

```
                    endpoint_attach() called
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Check Network    â”‚
                    â”‚ Interface        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
           Exists                    Missing
                â”‚                         â”‚
                â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Continue     â”‚         â”‚ Recreate?    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                        â”‚
                â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚                   â”‚
                â”‚           Success            Failure
                â”‚              â”‚                   â”‚
                â”‚              â–¼                   â–¼
                â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚     â”‚ Continue     â”‚     â”‚ Return Error â”‚
                â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ Log Details  â”‚
                â”‚            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Check Endpoint   â”‚
                    â”‚ Interface        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
           Exists                    Missing
                â”‚                         â”‚
                â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Continue     â”‚         â”‚ Recreate?    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                        â”‚
                â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚                   â”‚
                â”‚           Success            Failure
                â”‚              â”‚                   â”‚
                â”‚              â–¼                   â–¼
                â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚     â”‚ Continue     â”‚     â”‚ Return Error â”‚
                â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ Log Details  â”‚
                â”‚            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Setup cangw      â”‚
                    â”‚ Rules            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Return Success   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Interface Lifecycle Comparison

### Before Reboot Resilience

```
Plugin Start          Container Start         System Reboot         Container Restart
     â”‚                      â”‚                       â”‚                      â”‚
     â–¼                      â”‚                       â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚                       â”‚                      â”‚
â”‚ Network â”‚                â”‚                       â”‚                      â”‚
â”‚ Created â”‚                â”‚                       â”‚                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚                       â”‚                      â”‚
     â”‚                     â”‚                       â”‚                      â”‚
     â”‚  CreateEndpoint     â”‚                       â”‚                      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚                      â”‚
     â–¼                                              â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚                      â”‚
â”‚Endpoint â”‚                                        â”‚                      â”‚
â”‚ Created â”‚                                        â”‚                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                        â”‚                      â”‚
     â”‚                                              â”‚                      â”‚
     â”‚  Join                                        â”‚                      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                      â”‚
     â–¼                                          â”‚  â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚                      â”‚
â”‚ Attachedâ”‚                                     â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                     â”‚  â”‚                      â”‚
     â”‚                                          â”‚  â”‚                      â”‚
     â”‚  Container Running                       â”‚  â”‚                      â”‚
     â–¼                                          â”‚  â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â–¼                      â”‚
â”‚  vxcan  â”‚                                     â”‚ REBOOT                  â”‚
â”‚  exists â”‚                                     â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚  All interfaces      â”‚
                                                â”‚  â”‚  destroyed!          â”‚
                                                â”‚  â–¼                      â”‚
                                                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                                                â”‚ â”‚ Plugin   â”‚            â”‚
                                                â”‚ â”‚ Restarts â”‚            â”‚
                                                â”‚ â”‚          â”‚            â”‚
                                                â”‚ â”‚ Memory   â”‚            â”‚
                                                â”‚ â”‚ Empty    â”‚            â”‚
                                                â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
                                                â”‚      â”‚                  â”‚
                                                â”‚      â”‚  Join            â”‚
                                                â”‚      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚      â–¼
                                                â”‚ âŒ FAILURE
                                                â”‚ Endpoint not found
                                                â”‚ Interface missing
```

### After Reboot Resilience

```
Plugin Start          Container Start         System Reboot         Container Restart
     â”‚                      â”‚                       â”‚                      â”‚
     â–¼                      â”‚                       â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚                       â”‚                      â”‚
â”‚ Network â”‚                â”‚                       â”‚                      â”‚
â”‚ Created â”‚                â”‚                       â”‚                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚                       â”‚                      â”‚
     â”‚                     â”‚                       â”‚                      â”‚
     â”‚  CreateEndpoint     â”‚                       â”‚                      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚                      â”‚
     â–¼                                              â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚                      â”‚
â”‚Endpoint â”‚                                        â”‚                      â”‚
â”‚ Created â”‚                                        â”‚                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                        â”‚                      â”‚
     â”‚                                              â”‚                      â”‚
     â”‚  Join                                        â”‚                      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                      â”‚
     â–¼                                          â”‚  â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚                      â”‚
â”‚ Attachedâ”‚                                     â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                     â”‚  â”‚                      â”‚
     â”‚                                          â”‚  â”‚                      â”‚
     â”‚  Container Running                       â”‚  â”‚                      â”‚
     â–¼                                          â”‚  â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â–¼                      â”‚
â”‚  vxcan  â”‚                                     â”‚ REBOOT                  â”‚
â”‚  exists â”‚                                     â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚  All interfaces      â”‚
                                                â”‚  â”‚  destroyed!          â”‚
                                                â”‚  â–¼                      â”‚
                                                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                                                â”‚ â”‚ Plugin   â”‚            â”‚
                                                â”‚ â”‚ Restarts â”‚            â”‚
                                                â”‚ â”‚          â”‚            â”‚
                                                â”‚ â”‚ Memory   â”‚            â”‚
                                                â”‚ â”‚ Empty    â”‚            â”‚
                                                â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
                                                â”‚      â”‚                  â”‚
                                                â”‚      â”‚  Join            â”‚
                                                â”‚      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚      â–¼
                                                â”‚ ğŸ†• RECOVERY
                                                â”‚      â”‚
                                                â”‚      â”œâ”€â†’ Recreate endpoint
                                                â”‚      â”œâ”€â†’ Recreate network ifc
                                                â”‚      â”œâ”€â†’ Recreate vxcan pair
                                                â”‚      â””â”€â†’ Setup cangw rules
                                                â”‚      â”‚
                                                â”‚      â–¼
                                                â”‚ âœ… SUCCESS
                                                â”‚ Container starts
```

## Code Flow Summary

### New Functions Called During Recovery

```
api_network_join()
  â””â”€â†’ NetworkManager::endpoint_attach()
       â”‚
       â”œâ”€â†’ ğŸ†• Check: endpoint_list.contains_key()?
       â”œâ”€â†’ ğŸ†• If missing: Endpoint::new()           [endpoint.rs]
       â”‚
       â””â”€â†’ Network::endpoint_attach()
            â”‚
            â”œâ”€â†’ ğŸ†• ensure_network_interface_exists() [network.rs]
            â”‚    â”œâ”€â†’ network_interface_exists()     [network.rs]
            â”‚    â””â”€â†’ ip link add/set                [system call]
            â”‚
            â”œâ”€â†’ ğŸ†• Endpoint::ensure_interface_exists() [endpoint.rs]
            â”‚    â”œâ”€â†’ interface_exists()              [endpoint.rs]
            â”‚    â””â”€â†’ ip link add/set                 [system call]
            â”‚
            â”œâ”€â†’ add_cangw_rule()                     [existing]
            â””â”€â†’ ğŸ†• Peer validation loop              [network.rs]
                 â””â”€â†’ interface_exists() for peers     [endpoint.rs]
```

## Performance Timeline

### Cold Start (Post-Reboot)

```
Time: 0ms      10ms     20ms    30ms    40ms    50ms    60ms
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚
      â”œâ”€â†’ Join called
      â”‚
      â”œâ”€â†’ Check network interface (~1ms)
      â”‚   â””â”€â†’ Missing: recreate (~15ms)
      â”‚
      â”œâ”€â†’ Check endpoint interface (~1ms)
      â”‚   â””â”€â†’ Missing: recreate (~15ms)
      â”‚
      â”œâ”€â†’ Check peer interfaces (~1ms)
      â”‚
      â”œâ”€â†’ Create cangw rules (~5ms)
      â”‚
      â””â”€â†’ Return success
          â”‚
          Total: ~40-60ms (one-time cost)
```

### Warm Start (Normal Operation)

```
Time: 0ms      10ms     20ms
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚
      â”œâ”€â†’ Join called
      â”‚
      â”œâ”€â†’ Check network interface (~1ms)
      â”‚   â””â”€â†’ Exists: continue
      â”‚
      â”œâ”€â†’ Check endpoint interface (~1ms)
      â”‚   â””â”€â†’ Exists: continue
      â”‚
      â”œâ”€â†’ Check peer interfaces (~1ms)
      â”‚
      â”œâ”€â†’ Create cangw rules (~5ms)
      â”‚
      â””â”€â†’ Return success
          â”‚
          Total: ~10ms (no recreation needed)
```

## Key Design Decisions

1. **Lazy Recovery** - Interfaces recreated on-demand, not proactively
   - Pros: Fast plugin startup, only recreates what's needed
   - Cons: Slight delay on first container start post-reboot

2. **Idempotent Operations** - Can be called multiple times safely
   - Handles concurrent container starts
   - Graceful handling of race conditions

3. **Fail-Fast for Unrecoverable Errors** - Return errors immediately
   - Network not found â†’ Error (can't recover)
   - Interface creation fails â†’ Error with details
   - Command execution fails â†’ Error with context

4. **Transparent Recovery** - No user intervention required
   - No new configuration options
   - No docker-compose.yml changes
   - Works with existing networks

5. **Comprehensive Logging** - Every recovery action logged
   - Easy troubleshooting
   - Clear audit trail
   - Helpful error messages

